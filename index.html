<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catálogo Mayorista</title>
  <!-- Carga de TailwindCSS desde CDN para diseño responsivo -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Encabezado principal del catálogo -->
  <header class="bg-white shadow p-4 text-center">
    <h1 class="text-2xl font-bold">Catálogo Mayorista - Productos Digitales</h1>
  </header>

  <!-- Contenedor principal del catálogo y filtros -->
  <div class="max-w-6xl mx-auto p-4">
    <!-- Filtros de búsqueda -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Input de búsqueda por texto -->
      <input id="searchInput" type="text" placeholder="Buscar producto..." class="p-2 border rounded">
      
      <!-- Filtro por categoría -->
      <select id="categoryFilter" class="p-2 border rounded">
        <option value="">Todas las categorías</option>
      </select>
      
      <!-- Filtro por stock -->
      <select id="stockFilter" class="p-2 border rounded">
        <option value="">Stock</option>
        <option value="sí">En stock</option>
        <option value="no">Sin stock</option>
      </select>
      
      <!-- Filtro por rango de precio -->
      <div>
        <input id="priceRange" type="range" min="0" max="100" value="100" class="w-full">
        <span id="priceLabel" class="text-sm">Hasta: $100</span>
      </div>
    </div>

    <!-- Contenedor donde se mostrarán los productos -->
    <div id="catalogo" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <!-- Mensaje de error cuando no hay productos -->
    <p id="noResults" class="text-center text-gray-500 hidden">No se encontraron productos.</p>
  </div>

  <!-- Pie de página con información de contacto -->
  <footer class="bg-white text-center p-4 text-sm text-gray-500">
    Contacto WhatsApp: +51 929809650
  </footer>

  <!-- Script principal para cargar datos y manejar la lógica del catálogo -->
  <script>
    // URL de la hoja de Google Sheets
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1w1czDKnRvyYkUvRmt98N0EnTRGMqa3b-CyteYEcZZ0Q/gviz/tq?tqx=out:json";

    // Lista para almacenar los productos cargados
    let productos = [];

    // Función para cargar los datos desde Google Sheets
    async function cargarDatos() {
      try {
        // Petición a Google Sheets
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2)); // Parseo del JSON
        
        // Obtener nombres de las columnas (deben coincidir con los esperados)
        const cols = json.table.cols.map(c => c.label.toLowerCase());
        console.log("🔍 Columnas detectadas:", cols);

        // Mapear filas de datos en un arreglo de objetos
        productos = json.table.rows.map(row => {
          const obj = {};
          row.c.forEach((cell, i) => {
            obj[cols[i]] = cell?.v || ""; // Asignar valores; manejar celdas vacías
          });
          return obj;
        });

        console.log("✅ Productos cargados:", productos);
        mostrarProductos(); // Mostrar los productos
        cargarFiltros(); // Cargar opciones en los filtros
      } catch (error) {
        console.error("❌ Error al cargar datos:", error);
      }
    }

    // Función para mostrar los productos en el catálogo
    function mostrarProductos() {
      const contenedor = document.getElementById("catalogo");
      const noResults = document.getElementById("noResults");
      const search = document.getElementById("searchInput").value.toLowerCase();
      const categoria = document.getElementById("categoryFilter").value;
      const stock = document.getElementById("stockFilter").value;
      const precioMax = parseFloat(document.getElementById("priceRange").value);

      contenedor.innerHTML = ""; // Limpiar contenido previo

      // Filtrar los productos según los filtros seleccionados
      const productosFiltrados = productos.filter(p =>
        (!search || p["producto"].toLowerCase().includes(search)) &&
        (!categoria || p["categoria"] === categoria) &&
        (!stock || p["stock"] === stock) &&
        (!isNaN(precioMax) && parseFloat(p["precio_unidad"]) <= precioMax)
      );

      // Mostrar mensaje si no hay productos
      if (productosFiltrados.length === 0) {
        noResults.classList.remove("hidden");
      } else {
        noResults.classList.add("hidden");
        productosFiltrados.forEach(p => {
          const card = document.createElement("div");
          card.className = "bg-white p-4 shadow rounded flex flex-col";

          // Crear tarjeta del producto
          card.innerHTML = `
            <img src="${p.url_foto}" alt="${p.producto}" class="h-40 object-contain mb-2">
            <h2 class="text-lg font-bold mb-1">${p.producto}</h2>
            <p class="text-sm mb-1 font-semibold">${p.suscripcion}</p>
            <p class="text-sm mb-2">${p.descripcion}</p>
            <ul class="text-sm mb-4">
              <li>🎯 Unidad: $${p["precio_unidad"]}</li>
              <li>📦 ${p["pack_1"]}: $${p["precio_1"]}</li>
              <li>📦 ${p["pack_2"]}: $${p["precio_2"]}</li>
            </ul>
            <div class="grid grid-cols-1 gap-2">
              <a href="https://wa.me/51929809650?text=${encodeURIComponent(`Hola, quiero pedir:\n🛒 ${p.producto}\n✅ Opción: Unidad\n💲 Precio: $${p["precio_unidad"]}`)}" target="_blank" class="whatsapp-button bg-green-500 text-white text-sm py-2 rounded text-center">Comprar Unidad</a>
              <a href="https://wa.me/51929809650?text=${encodeURIComponent(`Hola, quiero pedir:\n🛒 ${p.producto}\n✅ Opción: ${p["pack_1"]}\n💲 Precio: $${p["precio_1"]}`)}" target="_blank" class="whatsapp-button bg-green-600 text-white text-sm py-2 rounded text-center">Comprar ${p["pack_1"]}</a>
              <a href="https://wa.me/51929809650?text=${encodeURIComponent(`Hola, quiero pedir:\n🛒 ${p.producto}\n✅ Opción: ${p["pack_2"]}\n💲 Precio: $${p["precio_2"]}`)}" target="_blank" class="whatsapp-button bg-green-700 text-white text-sm py-2 rounded text-center">Comprar ${p["pack_2"]}</a>
            </div>
          `;

          contenedor.appendChild(card);
        });
      }
    }

    // Función para cargar las categorías en el filtro
    function cargarFiltros() {
      const categorias = [...new Set(productos.map(p => p["categoria"]).filter(Boolean))];
      const select = document.getElementById("categoryFilter");
      categorias.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    // Listeners para los filtros
    document.getElementById("searchInput").addEventListener("input", mostrarProductos);
    document.getElementById("categoryFilter").addEventListener("change", mostrarProductos);
    document.getElementById("stockFilter").addEventListener("change", mostrarProductos);
    document.getElementById("priceRange").addEventListener("input", function () {
      document.getElementById("priceLabel").textContent = `Hasta: $${this.value}`;
      mostrarProductos();
    });

    // Cargar los datos al cargar la página
    cargarDatos();
  </script>
</body>
</html>
