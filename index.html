<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catálogo Mayorista</title>
  <!-- Cargar TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow p-4 text-center">
    <h1 class="text-2xl font-bold">Catálogo Mayorista - Productos Digitales</h1>
  </header>

  <div class="max-w-6xl mx-auto p-4">
    <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
      <input id="searchInput" type="text" placeholder="Buscar producto..." class="p-2 border rounded">
      <select id="categoryFilter" class="p-2 border rounded">
        <option value="">Todas las categorías</option>
      </select>
      <select id="stockFilter" class="p-2 border rounded">
        <option value="">Stock</option>
        <option value="sí">En stock</option>
        <option value="no">Sin stock</option>
      </select>
      <div>
        <input id="priceRange" type="range" min="0" max="200" value="200" class="w-full">
        <span id="priceLabel" class="text-sm">Hasta: $200</span>
      </div>
    </div>

    <div id="catalogo" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="noResults" class="text-center text-gray-500 hidden">No se encontraron productos.</p>
  </div>

  <footer class="bg-white text-center p-4 text-sm text-gray-500">
    Contacto WhatsApp: +51 929809650
  </footer>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1w1czDKnRvyYkUvRmt98N0EnTRGMqa3b-CyteYEcZZ0Q/gviz/tq?tqx=out:json";

    let productos = [];

    async function cargarDatos() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));

        // Obtener y validar nombres de columnas
        const cols = json.table.cols.map(c => c.label.toLowerCase());
        console.log("🔍 Columnas detectadas:", cols);

        const columnasEsperadas = [
          "producto", "suscripcion", "stock", "descripcion",
          "precio_unidad", "pack_1", "precio_1", "pack_2",
          "precio_2", "categoria", "url_foto"
        ];
        const faltantes = columnasEsperadas.filter(c => !cols.includes(c));
        if (faltantes.length > 0) {
          console.error("❌ Columnas faltantes en Google Sheets:", faltantes);
          return;
        }

        // Mapear filas a objetos
        productos = json.table.rows.map(row => {
          const obj = {};
          row.c.forEach((cell, i) => {
            const valor = cell?.v || "";
            obj[cols[i]] = valor.toString().trim(); // Convertir a cadena y limpiar espacios
          });

          // Limpiar valores de precios (eliminar "USD")
          obj.precio_unidad = parseFloat(obj.precio_unidad.replace("USD", "").trim()) || 0;
          obj.precio_1 = parseFloat(obj.precio_1.replace("USD", "").trim()) || 0;
          obj.precio_2 = parseFloat(obj.precio_2.replace("USD", "").trim()) || 0;

          return obj;
        });

        console.log("✅ Productos procesados:", productos);
        mostrarProductos();
        cargarFiltros();
      } catch (error) {
        console.error("❌ Error al cargar datos:", error);
      }
    }

    function mostrarProductos() {
      const contenedor = document.getElementById("catalogo");
      const noResults = document.getElementById("noResults");
      const search = document.getElementById("searchInput").value.toLowerCase();
      const categoria = document.getElementById("categoryFilter").value;
      const stock = document.getElementById("stockFilter").value;
      const precioMax = parseFloat(document.getElementById("priceRange").value);

      contenedor.innerHTML = ""; // Limpiar catálogo

      // Filtrar productos
      const productosFiltrados = productos.filter(p =>
        (!search || p["producto"].toLowerCase().includes(search)) &&
        (!categoria || p["categoria"] === categoria) &&
        (!stock || p["stock"].toLowerCase() === stock) &&
        (!isNaN(precioMax) && p["precio_unidad"] <= precioMax)
      );

      if (productosFiltrados.length === 0) {
        noResults.classList.remove("hidden");
        console.log("⚠️ No hay productos que coincidan con los filtros.");
      } else {
        noResults.classList.add("hidden");
        productosFiltrados.forEach(p => {
          const card = document.createElement("div");
          card.className = "bg-white p-4 shadow rounded flex flex-col";
          card.innerHTML = `
            <img src="${p.url_foto}" alt="${p.producto}" class="h-40 object-contain mb-2">
            <h2 class="text-lg font-bold mb-1">${p.producto}</h2>
            <p class="text-sm mb-1 font-semibold">${p.suscripcion || "Sin suscripción"}</p>
            <p class="text-sm mb-2">${p.descripcion || "Sin descripción"}</p>
            <ul class="text-sm mb-4">
              <li>🎯 Unidad: $${p["precio_unidad"].toFixed(2)}</li>
              <li>📦 ${p["pack_1"] || "Pack 1"}: $${p["precio_1"].toFixed(2)}</li>
              <li>📦 ${p["pack_2"] || "Pack 2"}: $${p["precio_2"].toFixed(2)}</li>
            </ul>
          `;
          contenedor.appendChild(card);
        });
      }
    }

    function cargarFiltros() {
      const categorias = [...new Set(productos.map(p => p["categoria"]).filter(Boolean))];
      const select = document.getElementById("categoryFilter");
      categorias.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    document.getElementById("searchInput").addEventListener("input", mostrarProductos);
    document.getElementById("categoryFilter").addEventListener("change", mostrarProductos);
    document.getElementById("stockFilter").addEventListener("change", mostrarProductos);
    document.getElementById("priceRange").addEventListener("input", function () {
      document.getElementById("priceLabel").textContent = `Hasta: $${this.value}`;
      mostrarProductos();
    });

    cargarDatos();
  </script>
</body>
</html>
