<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catálogo Mayorista</title>
  <!-- Cargar TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Cargar PapaParse desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow p-4 text-center">
    <h1 class="text-2xl font-bold">Catálogo Mayorista - Productos Digitales</h1>
  </header>

  <div class="max-w-6xl mx-auto p-4">
    <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
      <input id="searchInput" type="text" placeholder="Buscar producto..." class="p-2 border rounded">
      <select id="categoryFilter" class="p-2 border rounded">
        <option value="">Todas las categorías</option>
      </select>
      <select id="stockFilter" class="p-2 border rounded">
        <option value="">Stock</option>
        <option value="sí">En stock</option>
        <option value="no">Sin stock</option>
      </select>
      <div>
        <input id="priceRange" type="range" min="0" max="200" value="200" class="w-full">
        <span id="priceLabel" class="text-sm">Hasta: $200</span>
      </div>
    </div>

    <div id="catalogo" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="noResults" class="text-center text-gray-500 hidden">No se encontraron productos.</p>
  </div>

  <footer class="bg-white text-center p-4 text-sm text-gray-500">
    Contacto WhatsApp: +51 929809650
  </footer>

  <script>
    // URL del archivo CSV en el repositorio de GitHub
    const CSV_URL = "https://raw.githubusercontent.com/Cbecerrauntels/catalogo-distribuidores/refs/heads/main/CATALOGO%20DGC%20-%20Hoja%201.csv";

    let productos = [];

    // Función para cargar datos desde CSV
    async function cargarDatosDesdeCSV() {
      try {
        const res = await fetch(CSV_URL);
        const csvText = await res.text();

        // Parsear CSV con PapaParse
        const parsed = Papa.parse(csvText, { header: true });
        console.log("🔍 Datos parseados desde CSV:", parsed.data);

        // Limpiar los nombres de las columnas detectadas
        const columnasDetectadas = Object.keys(parsed.data[0] || {}).map(c => c.trim().toLowerCase());
        console.log("🔍 Columnas detectadas (limpiadas):", columnasDetectadas);

        // Columnas esperadas
        const columnasEsperadas = [
          "producto", "suscripcion", "stock", "descripcion",
          "precio_unidad", "pack_1", "precio_1", "pack_2",
          "precio_2", "categoria", "url_foto"
        ];

        // Verificar si faltan columnas
        const faltantes = columnasEsperadas.filter(c => !columnasDetectadas.includes(c));
        if (faltantes.length > 0) {
          console.error("❌ Columnas faltantes en el CSV:", faltantes);
          return;
        }

        // Procesar datos y limpiar precios
        productos = parsed.data.map(p => ({
          producto: p.producto?.trim() || "",
          suscripcion: p.suscripcion?.trim() || "",
          stock: p.stock?.trim() || "",
          descripcion: p.descripcion?.trim() || "",
          precio_unidad: parseFloat((p.precio_unidad || "0").replace("USD", "").trim()) || 0,
          pack_1: p.pack_1?.trim() || "",
          precio_1: parseFloat((p.precio_1 || "0").replace("USD", "").trim()) || 0,
          pack_2: p.pack_2?.trim() || "",
          precio_2: parseFloat((p.precio_2 || "0").replace("USD", "").trim()) || 0,
          categoria: p.categoria?.trim() || "",
          url_foto: p.url_foto?.trim() || ""
        }));

        console.log("✅ Productos procesados:", productos);
        mostrarProductos();
        cargarFiltros();
      } catch (error) {
        console.error("❌ Error al cargar datos desde CSV:", error);
      }
    }

    // Función para mostrar productos en el catálogo
    function mostrarProductos() {
      const contenedor = document.getElementById("catalogo");
      const noResults = document.getElementById("noResults");
      const search = document.getElementById("searchInput").value.toLowerCase();
      const categoria = document.getElementById("categoryFilter").value;
      const stock = document.getElementById("stockFilter").value;
      const precioMax = parseFloat(document.getElementById("priceRange").value);

      contenedor.innerHTML = ""; // Limpiar catálogo

      // Filtrar productos
      const productosFiltrados = productos.filter(p =>
        (!search || p["producto"].toLowerCase().includes(search)) &&
        (!categoria || p["categoria"] === categoria) &&
        (!stock || p["stock"].toLowerCase() === stock) &&
        (!isNaN(precioMax) && p["precio_unidad"] <= precioMax)
      );

      if (productosFiltrados.length === 0) {
        noResults.classList.remove("hidden");
      } else {
        noResults.classList.add("hidden");
        productosFiltrados.forEach(p => {
          const card = document.createElement("div");
          card.className = "bg-white p-4 shadow rounded flex flex-col";
          card.innerHTML = `
            <img src="${p.url_foto}" alt="${p.producto}" class="h-40 object-contain mb-2">
            <h2 class="text-lg font-bold mb-1">${p.producto}</h2>
            <p class="text-sm mb-1 font-semibold">${p.suscripcion}</p>
            <p class="text-sm mb-2">${p.descripcion}</p>
            <ul class="text-sm mb-4">
              <li>🎯 Unidad: $${p["precio_unidad"].toFixed(2)}</li>
              <li>📦 ${p["pack_1"]}: $${p["precio_1"].toFixed(2)}</li>
              <li>📦 ${p["pack_2"]}: $${p["precio_2"].toFixed(2)}</li>
            </ul>
          `;
          contenedor.appendChild(card);
        });
      }
    }

    // Función para cargar las categorías en el filtro
    function cargarFiltros() {
      const categorias = [...new Set(productos.map(p => p["categoria"]).filter(Boolean))];
      const select = document.getElementById("categoryFilter");
      categorias.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    // Listeners para los filtros
    document.getElementById("searchInput").addEventListener("input", mostrarProductos);
    document.getElementById("categoryFilter").addEventListener("change", mostrarProductos);
    document.getElementById("stockFilter").addEventListener("change", mostrarProductos);
    document.getElementById("priceRange").addEventListener("input", function () {
      document.getElementById("priceLabel").textContent = `Hasta: $${this.value}`;
      mostrarProductos();
    });

    // Cargar datos al iniciar
    cargarDatosDesdeCSV();
  </script>
</body>
</html>
